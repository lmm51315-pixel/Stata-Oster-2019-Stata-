# Stata 程序编写：Oster (2019) 系数稳定性检验的 Stata 实现

> **Source**: Oster, E. (**2019**). Unobservable Selection and Coefficient Stability: Theory and Evidence. **Journal of Business & Economic Statistics**, 37(2), 187–204. [Link](https://doi.org/10.1080/07350015.2016.1227711), [PDF](http://sci-hub.ren/10.1080/07350015.2016.1227711), [Google](<https://scholar.google.com/scholar?q=Unobservable Selection and Coefficient Stability: Theory and Evidence>). [-cited-5000次](https://scholar.google.com/scholar?cites=11936978270607540916&as_sdt=2005&sciodt=0,5&hl=zh-CN), [github-`coefstability`](https://github.com/gratzt/Coef-Stability-Oster)

> **作者：** 马俊豪 (中山大学岭南学院)
>
> **邮箱:**  <lmm51315@163.com>

**摘要** ：
在经验研究与因果推断中，评估遗漏变量偏误（Omitted Variable Bias）对估计结果的影响至关重要。传统上仅依赖“加入控制变量后系数是否稳定”的定性判断往往不够严谨，忽略了模型拟合优度（$R^2$）变动所蕴含的关键信息。基于 Oster (2019) 提出的理论框架，本文开发了 Stata 命令 `coefstability`，实现了系数稳定性检验的自动化。该命令通过对比基准模型与完整模型的系数及 $R^2$ 变化，结合不可观测变量的选择比例（$\delta$）与最大理论拟合优度（$R_{\max}$），计算经偏误调整后的处理效应（$\beta^*$）及使效应归零的临界选择强度（$\delta^*$）。本文详细介绍了该命令的语法结构、参数设定及 Bootstrap 推断功能，并通过复现 *Energy Economics* 两篇近期文献（Acheampong & Said, 2024; Cepni et al., 2024），展示了其在截面与面板数据分析中的应用。`coefstability` 为研究者提供了一个便捷、严谨的工具，以量化评估实证结果的稳健性。

---

目录
[TOC]

# 1. 引言

因果推断研究中常常面临控制变量不完备导致的遗漏变量偏误问题。换言之，即使我们在回归中加入了一系列观察到的控制变量，仍可能存在未观察到的混杂因素影响处理效应的估计。经验研究者通常采用一种朴素的方法来评估遗漏变量偏误的风险：比较加入控制变量前后的系数是否稳定。如果在纳入观测控制变量后，处理效应的回归系数几乎没有变化，研究者往往据此认为遗漏变量偏误有限。然而，仅仅依赖系数的“稳定”并不足以保证因果推断的稳健性。正如 Oster（2019）指出的，判断未观察因素是否会推翻结果，不仅要看系数的变动，还应考虑模型拟合优度 $R^2$ 的变化。如果加入控制变量后 $R^2$ 大幅提升而系数几乎不变，这表明即使存在能提高 $R^2$ 的未观察变量，估计结果也不大可能被颠覆；反之，如果系数对控制变量非常敏感，即使 $R^2$ 提升不大，未观察变量仍可能对结果产生显著影响。

为了解决这一问题，Oster（2019）提出了一种形式化的系数稳定性检验方法，结合系数变动和 $R^2$ 变化来推断遗漏变量偏误可能造成的影响。她的方法引入了一个关键参数 $\delta$ 表示“未观察变量的选择偏向强度相对于已观察变量的比例”，并利用理论上的最大 $R^2$ （记作 $R_{\max}$）来推算在存在未观察混杂时处理效应系数可能达到的范围。本文介绍的 `coefstability` 命令由作者 YM 开发，旨在将 Oster 方法在 Stata 中自动化，实现对处理效应估计稳健性的方便检验。通过该命令，研究者只需提供回归结果和假定的 $\delta$ 与 $R_{\max}$ 等参数，即可轻松评估未观察变量偏误对估计系数的潜在影响，从而为因果推断结果的稳健性提供更有力的支持。

---

# 2. 文章理论回顾

本节旨在阐明传统处理遗漏变量偏误（Omitted Variable Bias, OVB）方法的局限性，并系统阐述Oster（2019）提出的检验方法及其数理基础。

## 2.1 一个直观可算的数学例子

传统研究中，研究者常以“加入控制变量后核心解释变量的系数保持稳定”为依据，推断遗漏变量偏误可能不严重。Oster（2019）指出，仅依赖“系数稳定性”这一标准并不可靠。本节通过一个简化的教育回报率示例，说明单独观察系数变动可能导致的误判，并论证必须同时考察系数与模型拟合优度（$R^2$）的联合变动。

### 2.1.1 基本假设

具体地，考虑一个真实工资决定式：

$$
Y=\beta X+W+C,
$$

其中：

- $X$：教育（treatment），**假设其真实效应为零**
- $W,C$：能力(ability)的两个**正交**分量

并且：

1. **方差差异**：$\text{Var}(W)\gg \text{Var}(C)$（$W$是“高方差能力”，$C$是“低方差能力”）。
2. **与$X$的关系“相同”**：把$X$分别对$W$或对$C$做一元回归，得到的斜率相同：

$$
\pi \equiv \frac{\text{Cov}(X,W)}{\text{Var}(W)}
      = \frac{\text{Cov}(X,C)}{\text{Var}(C)}.
$$

则当**真实效应为零**时，可以得到：

$$
Y=W+C
$$

假设我们只能观测到一个能力代理变量：要么观察到$W$，要么观察到$C$。

---

### 2.1.2 “只关注系数稳定”的问题

如果我们只观测到了C，那么此时看“无控制”与“控制$C$”的对比：

- 无控制：

$$
\hat\beta^{\,0}
=\frac{\text{Cov}(X,W)+\text{Cov}(X,C)}{\text{Var}(X)}.
$$

- 控制$C$：

$$
\hat\beta^{\,C}
=\frac{\text{Cov}(X,W)}
{\text{Var}(X)-\frac{\text{Cov}(X,C)^2}{\text{Var}(C)}}.
$$

如果$\text{Var}(C)$很小，那么$\text{Cov}(X,C)$也会很小（在“回归$X$对$C$与对$W$斜率相同”的假设下更是如此：$\text{Cov}(X,C)=\pi\text{Var}(C)$）。
于是：

- $\hat\beta^{\,0}$里那项$\text{Cov}(X,C)$本来就很小；
- $\hat\beta^{\,C}$的分母修正项$\text{Cov}(X,C)^2/\text{Var}(C)$也很小（数量级是$\text{Var}(C)$）。

因此会出现：

$$
\hat\beta^{\,C}\approx \hat\beta^{\,0}.
$$

这制造了一种系数稳定的表象：控制一个低方差的代理变量后，$X$ 的系数变动甚微。然而，由于真实效应 $\beta = 0$，而 $\hat\beta^{,0}$ 与 $\hat\beta^{,C}$ 皆可能显著不为零，其偏误根源在于遗漏的高方差能力分量 $W$ 仍然存在。

---

### 2.1.3 引入 $R^2$ 变动作为诊断工具

系数稳定而偏误仍在，关键在于控制变量 $C$ 对结果变量 $Y$ 的解释力很弱。这一缺陷可通过考察模型 $R^2$ 的变动来揭示。

- **无控制时R²**：
  在简单回归 $Y\sim X$ 下：

  $$
  _0^2=\frac{\text{Cov}(X,Y)^2}{\text{Var}(X)\text{Var}(Y)}.
  $$

  因为$\beta=0\Rightarrow Y=W+C$ 且 $W\perp C$，

  $$
  \text{Var}(Y)=\text{Var}(W)+\text{Var}(C),
  \quad
  \text{Cov}(X,Y)=\text{Cov}(X,W)+\text{Cov}(X,C).
  $$
- **控制$W$时R²**：
  在回归 $Y\sim X+W$ 中，$W$本身就是$Y$里的一个大块分量（$\text{Var}(W)$很大），因此仅仅加入$W$就能解释掉几乎$\text{Var}(W)$这么多的方差。
  更形式化地：控制$W$后，$Y-W=C$，此时额外由$X_W$解释的只是$C$的一小部分，所以

$$
R_{X,W}^2
\approx \frac{\text{Var}(W)}{\text{Var}(W)+\text{Var}(C)}
\approx 1.
$$

- **控制$C$时R²**：
  在回归 $Y\sim X+C$ 中，加入$C$最多也只能“直接”解释掉$\text{Var}(C)$这部分方差。
  而$\text{Var}(C)$很小，因此即使加入$C$，R²的增量也会很小：

$$
R_{X,C}^2 - R_0^2 \ \text{通常很小}.
$$

这正是“低方差控制变量信息含量低”的诊断：**它既没怎么改变系数，也没怎么提升R²。**

---

### 2.1.4 小结

只考虑系数的稳定性并不稳妥，还需要把$R^2$的运动纳入进来，因为如果控制变量对解释结果变量的方差几乎没有贡献（$R^2$变动极小），那么即使系数非常稳定，也可能只是因为这些控制变量本身“质量很差”，不足以消除潜在的偏误

## 2.2  Oster (2019) 提出的系数稳定性检验方法

本节旨在阐述清楚 Oster (2019) 提出的系数稳定性检验方法的数理基础,以及其中一些重要参数的选取标准与经验。

### 2.2.1 模型设定与基本假设

我们首先描述 Oster (2019) 在第三节中使用的线性模型设定和符号约定。
考虑线性回归模型：

- **基本模型：** $Y = \beta X + W_1 + W_2 + \varepsilon$
- 其中：$X$ 是处理变量（标量），$Y$ 是结果变量。$W_1$ 表示**观测到的**混淆因素的**指数**（index），$W_2$ 表示**未观测到的**混淆因素的指数，$\varepsilon$ 是独立误差项。模型中 $W_1$ 和 $W_2$ 分别代表已控制和未控制的混杂影响，两者均以**系数1**加权进入结果方程，这意味着我们已将观测控制变量的线性组合 $W_1$ 定义为它们对 $Y$ 的总贡献。
- **正交性假定：** 假定 $W_1$ 与 $W_2$ 正交，即相关系数为0。这意味着观测到的控制因素 $W_1$ 与未观测因素 $W_2$ 没有关联，从而将观测组和未观测组的影响区分开来。这一假设主要是为了方便推导**比例选择关系**，实际只要存在某个 $\delta$ 满足比例关系，该假设并不失一般性。
- **比例选择系数 $\delta$：** 定义**选择比例关系**为

  $$
  \delta \frac{\sigma_{1X}}{\sigma_1^2} \;=\; \frac{\sigma_{2X}}{\sigma_2^2},
  $$

  其中 $\sigma_{iX} = \mathrm{Cov}(W_i, X)$ 是 $W_i$ 与处理 $X$ 的协方差，$\sigma_i^2 = \mathrm{Var}(W_i)$ 是 $W_i$ 的方差（$i=1,2$ 分别对应观测和未观测部分）。系数 $\delta$ 度量了**未观测变量与处理的关联强度相对于观测变量的关联强度**：当 $\delta = 1$ 时表示**观测变量和未观测变量对处理的选择偏差程度相同**（“等比例选择”）；$\delta > 1$ 表示未观测部分相对于观测部分更强（更严重的选择偏差），而 $\delta < 1$ 则表示未观测部分相对较弱。
- **回归系数与 $R^2$ 定义：** 不包含任何控制时回归 $Y$ 关于 $X$ 的系数记为 $\beta_0$，对应的 $R^2$ 记为 $R_0$。包含观测控制 $\omega_o$（即 $W_1$ 所代表的控制集合）时的回归系数记为 $\beta_1$，$R^2$ 记为 $R_1$。设想如果能够控制全部观测和未观测变量，则该“完全回归”中 $X$ 的系数为真实的因果效应 $\beta$，其对应的理论 $R^2$ 记为 $R_{\max}$。
  注意：$R_{\max}$ 是一个理论上的上限值，满足 $R_1 \le R_{\max} \le 1$。

上述设定中，$\beta_0$ 和 $\beta_1$ 都可能因为遗漏变量偏误而偏离真实效应 $\beta$。$\beta_0$ 是只含处理的“短回归”系数，包含了由于遗漏 **$W_1$** 和 **$W_2$** 导致的偏误；$\beta_1$ 是包含观测控制的“中间回归”系数，只剩下遗漏 **$W_2$** 导致的偏误。我们用这些符号正式推导命题1至3所述的结果。

---

### 2.2.2 命题1：有约束情形下的偏误调整估计（等比例选择，$\delta = 1$）

在一个**受限的情形**下给出了偏误校正后系数的解析形式和一致性。这个受限情形采用了两个额外假设：

- **假设 1（等比例选择）**：$\delta = 1$，即默认观测与未观测混杂对处理的关联程度相同；
- **假设 2**：观测控制中各变量对 $X$ 和对 $Y$ 的相对贡献保持相同比例。第二个假设技术上保证了当我们以 $W_1$ 指数代表所有观测控制时，不会因各控制影响力不均而引入偏差——直观而言，它要求“每个观测控制对 $X$ 的解释力与其对 $Y$ 的影响力成比例”。虽然在实际中多个控制很难严格满足这一关系，但如果偏离不严重，结果仍近似成立。在这两个假设下，我们可以得到**偏误一致估计**的简单形式。

**1. 系数偏误的表达：**

利用线性回归遗漏变量偏误公式，表示 $\beta_0$ 和 $\beta_1$ 的偏差部分。由于 $W_1, W_2$ 在结构方程中系数为1：

*   **无控制回归的系数 $\beta_0$：** 包含所有遗漏偏误。由 $Y = \beta X + W_1 + W_2 + \varepsilon$，有

    $$
    \beta_0 \;=\; \beta + \frac{\mathrm{Cov}(X,\,W_1 + W_2)}{\mathrm{Var}(X)} \;=\; \beta + \frac{\sigma_{1X} + \sigma_{2X}}{\sigma_X^2}\,.
    $$

    其中附加项 $\frac{\sigma_{1X} + \sigma_{2X}}{\sigma_X^2}$ 正是由于遗漏 $W_1, W_2$ 引入的总偏误。

*   **有观测控制回归的系数 $\beta_1$：** 仅遗漏 $W_2$ 的偏误。对 $Y$ 关于 $X$ 和 $W_1$ 回归，$W_1$ 已包含在回归中，只剩 $W_2$ 的影响未被控制。此时 $X$ 的系数由对 $W_2$ 的遗漏引起偏误：

    $$
    \beta_1 \;=\; \beta + \frac{\mathrm{Cov}(X,\,W_2 \mid W_1)}{\mathrm{Var}(X \mid W_1)}\,.
    $$

    由于 $W_1$ 与 $W_2$ 正交，$\mathrm{Cov}(X, W_2 \mid W_1) = \mathrm{Cov}(X,W_2) = \sigma_{2X}$。而 $\mathrm{Var}(X \mid W_1) = \sigma_X^2 - \frac{\sigma_{1X}^2}{\sigma_1^2}$：这体现了控制 $W_1$ 后 $X$ 剩余的方差（记作 $\tau_x$）。因此，

    $$
    \beta_1 \;=\; \beta + \frac{\sigma_{2X}}{\sigma_X^2 - \frac{\sigma_{1X}^2}{\sigma_1^2}} \;=\; \beta + \frac{\sigma_{2X}}{\tau_x}\,.
    $$

  该偏误项可进一步用 $\delta=1$ 简化：当 $\delta=1$，根据比例选择关系有 $\sigma_{2X}/\sigma_2^2 = \sigma_{1X}/\sigma_1^2$，从而 $\frac{\sigma_{2X}}{\tau_x} = \frac{\sigma_{2X}}{\sigma_X^2 - \sigma_{1X}^2/\sigma_1^2}$。
  方便起见：记 $\phi = \beta_1 - \beta$ 为在包含观测控制后的剩余偏误（即遗漏 $W_2$ 导致的偏误）。

- 基于以上，$\beta_0$ 与 $\beta_1$ 的关系可以写为：
  $$
  \beta_0 - \beta_1 \;=\; \frac{\sigma_{1X} + \sigma_{2X}}{\sigma_X^2} \;-\; \frac{\sigma_{2X}}{\sigma_X^2 - \frac{\sigma_{1X}^2}{\sigma_1^2}}\,,
  $$

  而 $\beta_1 - \beta = \phi$（此时 $\phi$ 也可写成上述差式的等价形式）。为了获得校正偏误的估计量，我们需要将 $\phi$ 解出并扣除。

**2. 系数变化与 $R^2$ 变化的比例关系**：

在假设 $\delta=1$ 下，Oster 证明了一个重要的比例关系：**系数移动的比例等于 $R^2$ 移动的比例**。也就是说，在等比例选择假设下：

$$
\frac{\beta_1 - \beta}{\,\beta_0 - \beta_1\,} \;=\; \frac{R_{\max} - R_1}{\,R_1 - R_0\,}\,
$$

其中左边是“**系数减少量**与**剩余偏误量**之比”，右边是“**已解释 $R^2$ 增量**与**剩余未解释 $R^2$ 比率**”。

理解这一比例关系的直观含义：当观测变量和未观测变量对处理的关联程度相同（$\delta=1$）时，**加入观测控制所导致的系数变化比例，应该等于这些控制对 $R^2$ 的贡献比例**。换言之，如果观测控制已经消除了相对于全部混杂因素的一定比例的偏误，那么它们也解释了相应比例的结果方差；二者比例相同意味着观测部分与未观测部分在影响上的对称性。只有当未观测混杂的方差不同于观测混杂时，这一比例关系才会偏离1，但这部分差异正好体现为 $R^2$ 贡献的差异。

**3. 偏误调整系数的解：**
利用上述比例关系，我们可以求解未观测偏误 $\beta_1 - \beta$ 并构造偏误调整后的系数估计。根据比例关系可得：

$$
\beta_1 - \beta \;=\; (\beta_0 - \beta_1)\,\frac{R_{\max} - R_1}{\,R_1 - R_0\,}\,.
$$

将右侧表示的偏误量从包含控制的系数中扣除，即可得到**校正后的处理效应估计** $\beta^*$：

$$
\beta^* \;=\; \beta_1 \;-\; \Big(\beta_0 - \beta_1\Big)\,\frac{R_{\max} - R_1}{\,R_1 - R_0\,}\,.
$$

这一公式正是 Oster (2019) 在命题1中给出的结果。

**4. 命题1的结论与验证：** 根据推导，所定义的 $\beta^*$ 是对真实系数 $\beta$ 的一致估计，即在样本量趋于无穷时 $\beta^* \xrightarrow{p} \beta$。**命题1**正式表述为：在假设 1 和 2 下，所构造的

$$
\beta^* = \beta_1 - (\beta_0 - \beta_1)\frac{R_{\max} - R_1}{R_1 - R_0}
$$

满足 $\beta^* \overset{p}{\to} \beta$。

**5. 直观解释：** **命题1**强调了**系数稳定性结合 $R^2$ 变化**在推断偏误时的重要作用。等比例选择假设下，观测控制对系数的影响程度可以直接比照其对 $R^2$ 的影响来推断未观测偏误。若加入控制变量后系数几乎不变但 $R^2$ 提升显著，那么根据上述公式计算出的 $\beta^*$ 将非常接近原始系数，暗示未观测偏误也许很小（结果稳健）；反之，如果加入控制后系数剧烈变化而 $R^2$ 变化不大，则 $\beta^*$ 调整值偏离 $\beta_1$ 较远，提示潜在的未观测偏误较大。因此，在 **$\delta = 1$** 框架下，**“系数的稳定”只有结合“$R^2$的稳定”才能判断稳健性**。

---

### 2.2.3 命题2：无约束情形下的广义估计（放松假设，任意 $\delta$）

**命题2**放松了命题1中的**假设2**，讨论更加一般的情形下（允许 $\delta \neq 1$，且不要求假设2严格成立）偏误校正估计的形式。在这种**非约束**情况下，我们仅保留基本的**假设1**：“观测与未观测成比例选择”，但 $\delta$ 可以是任意给定值（根据经验或情景假定），不再固定为1。同时，不要求各观测控制对 $X$ 和 $Y$ 的贡献完全成比例，因此放松假设 2。此时，要得到 $\beta$ 的一致估计，需要解一个关于偏误的**三次方程**。

**1. 一般情形的方程组：** 放松限制后，我们仍可写出类似命题1中的三个关系式，只是其中将出现 $\delta$ 参数及额外的不直接观测量（例如 $\tau_x = \mathrm{Var}(X \mid W_1)$）。这些关系可概括为：

- 系数差值与协方差的关系（推广了命题1中 $\beta_0 - \beta_1$ 的表达）。
- $R^2$ 差值的表达（$R_1 - R_0$、$R_{\max} - R_1$）与变量方差的关系（包括 $\tau_x$ 等）。
- 偏误项 $\phi = \beta_1 - \beta$ 与上述量之间的关系（包含 $\delta$）。

将这些关系联立，可以得到一个关于 $\phi$ 的三次多项式方程 $f(\phi) = 0$。具体而言，$f(\nu)$ 形如：

$$
f(\nu) = a_0 + a_1 \nu + a_2 \nu^2 + a_3 \nu^3 = 0\,,
$$

其中系数 $a_i$ 是已知量的组合，包含 $\delta$、$\sigma$ 和 $R$ 等。例如，最高阶项的系数与 $(\delta - 1)$ 和 $\tau_x\sigma_X^2 - \tau_x^2$ 成比例，从而 **当 $\delta=1$ 时方程降为二次**（与命题1结果一致），而 $\delta \neq 1$ 则一般得到三次方程。

**2. 精确解：** 三次方程最多有三个实根。命题2据此分两种情形：

- **情形1：唯一实根。**如果 $f(\nu)$ 只有一个实数解（其余为共轭复数对），则我们记这个根为 $\nu_1$。此时偏误 $\phi = \nu_1$ 的解是唯一的，进而**校正后的系数估计唯一**：$\beta^* = \beta_1 - \nu_1$。在样本趋于无限时，这唯一解对应的 $\beta^*$ 将收敛于真值 $\beta$。
- **情形2：三个实根。**如果 $f(\nu)$ 出现三个不同的实数解 $\nu_1, \nu_2, \nu_3$，则可构造对应的三个候选估计值 $\beta^* \in \{\beta_1 - \nu_1,\; \beta_1 - \nu_2,\; \beta_1 - \nu_3\}$。理论上，其中**只有一个**解是正确的（收敛于 $\beta$），其余两个为由模型不充分假定导致的伪解。

但只要保持**比例选择假设**（即使 $\delta \neq 1$），上述过程总能在候选集合中找到正确的 $\beta^*$。这一命题扩展了 Altonji, Elder, Taber (2005) 对二分类 $X$ 情况的结果。为了实际应用，需要解决**如何辨别正确解**的问题。通常，我们可以基于经济含义的额外约束来筛选解。例如，假设**未观测偏误不会改变相关性的方向**（即 $X$ 与总偏误 $W_1 + W_2$ 的协方差符号与 $X$ 与观测部分 $W_1$ 的协方差符号一致）。在该假设下，我们可排除不合理的根，从而选定与真效应符号一致、幅度合理的 $\beta^*$。例如，如果控制变量的加入使系数向零靠拢，我们预期加入未观测控制应进一步使系数朝同一方向变化，而不会**反向**翻转原结论。这种逻辑有助于识别真正的根解。

**3. 近似解：** 虽然命题2的严格证明需要解方程，但在论文中 Oster 提供了一个近似的**解析表达**来增强直觉。该表达表明，在放松等比例选择假设时，偏误调整公式相对于命题1出现一个简单的 $\delta$ 倍率因子：

$$
\beta^* \approx \beta_1 \;-\; \delta\,(\beta_0 - \beta_1)\,\frac{R_{\max} - R_1}{\,R_1 - R_0\,}\,.
$$

可以看出，当 $\delta=1$ 时，这就退化为命题1的结果；而 $\delta$ 越大（未观测选择偏差越严重），调整量就相应放大，$\beta^*$ 会离 $\beta_1$ 较远。这一近似公式**并非严格证明的估计量**，而是基于附加假设得到的简化形式，但在许多情形下非常接近精确解。因此，研究者在应用中经常直接使用这一公式作为稳健性分析的计算工具，只需为 $\delta$ 选择适当值即可。

综上，命题2提供了在更一般假定下估计 **“偏误校正处理效应”** 的方法。尽管解析求解较复杂，但关键结论是：**给定一个假设的选择比 $\delta$ 和 $R_{\max}$，我们可以通过上式（或严格解方程）计算出对应的 $\beta^*$ 来调整估计偏误**。当存在多重解时，需要借助额外信息选取最合理的那个。而通常，研究者会在实践中选取具有明确含义的 $\delta$ 值来直接应用这一调整公式。

---

### 2.2.4 命题3：使处理效应为0的 $\delta$ 解（反推所需的选择比例）

命题3关注的不是直接求 $\beta$，而是反过来**求出使某指定效应值成立所需的 $\delta$**。特别地，一个重要应用是计算**需要多大的未观测选择偏差（相对于观测偏差）才能使处理效应归零**。这一命题对于稳健性分析意义重大，因为它回答了一个政策研究常问的问题：“**需要多少未观测偏差可以解释掉当前结果？**”

**1. 命题3的定义：** 令 $\hat{\beta}$ 表示我们关注的某一特定效应值（例如 0，以检验零效性假设）。命题3将 $\hat{\delta}$ 定义为：在给定 $R_{\max}$ 的情况下，使真实效应 $\beta = \hat{\beta}$ 所需的比例系数。换言之，$\hat{\delta}$ 满足当 $\delta = \hat{\delta}$ 时，通过命题2的调整公式得到 $\beta^* = \hat{\beta}$。命题3推导了 $\hat{\delta}$ 的显式表达式。公式在原文中较复杂（为三次方程求根的结果），我们以下只针对特别重要的情形（ $\hat{\beta}=0$ ）进行说明。

当 $\hat{\beta} = 0$ 时，$\hat{\delta}$ 表示**使处理效应刚好为0所需的未观测相对选择强度**。利用偏误调整公式近似形式，我们可以重新排列得到 $\hat{\delta}$ 的计算公式。例如，从上一节的近似公式：

$$
0 = \beta_1 - \hat{\delta}\,(\beta_0 - \beta_1)\frac{R_{\max} - R_1}{R_1 - R_0}\,,
$$

解得

$$
\hat{\delta} = \frac{\beta_1}{\,\beta_0 - \beta_1\,}\;\frac{R_1 - R_0}{\,R_{\max} - R_1\,}\,.
$$

这个结果直观地表示：当前观测系数占未解释系数移动量的比例，与剩余方差占已解释方差的比例之比，决定了需要的 $\delta$。如果 $\beta_1$ 非常接近 $\beta_0$（控制前后系数几乎不变），则 $\beta_1/(\beta_0-\beta_1)$ 很大，意味着即便未观测偏误相当弱（小的 $\hat{\delta}$）也难以将效应推至0；反之，如果加入控制后系数已经剧烈衰减（$\beta_1 \ll \beta_0$），则可能一个较小的 $\delta$ 即足以将系数完全削弱至0。

命题3严格的推导给出了普遍形式的 $\hat{\delta}$ 公式。在应用中，我们通常将注意力放在 **$\hat{\beta}=0$** 的情况，并据此报告“解释结果为零所需的 $\delta$”。这也被称为 **“Oster's $\delta$”** 或 **“程度阈值”**。例如，如果计算得到 $\hat{\delta} = 2$，意味着**未观测变量与处理的关联强度需要是观测变量的两倍**才能将当前估计系数归零；相应地，若 $\hat{\delta} = 0.5$，则只要未观测偏差强度达到观测的一半就足以推翻结果。

**2. 解释和意义：**$\hat{\delta}$ 提供了一种**鲁棒性阈值**的衡量。一般地，若得到的 $\hat{\delta}$ 很大（远大于1），表示需要极强的未观测偏差才能使结果消失——这通常被解读为结果相当稳健，因为我们认为现实中未观测因素不太可能比已观测因素更强地影响处理选择。相反，如果 $\hat{\delta}$ 小于1，甚至接近0，则说明即使未观测偏差比观测的弱很多，也可能推翻结果——此时结果的稳健性令人担忧。经验上一般采用 $\hat{\delta}=1$ 作为经验判断的分界线：$\hat{\delta} > 1$ 被视为观测的控制已经足够重要（**观测因素至少和未观测因素一样重要**），结果比较稳健；而 $\hat{\delta} < 1$ 则提示需要警惕未观测偏差的问题。

需要注意的是，$\hat{\delta}$ 的计算需要先行假定 $R_{\max}$ 值（因为 $\hat{\delta}$与 $R_{\max}$ 相关）。因此在使用命题3时，我们往往**先取定一个 $R_{\max}$**，然后求对应的 $\hat{\delta}$。下一节将讨论 $R_{\max}$ 的选取策略。

---

### 2.2.5 参数选取与稳健性评估

在实践中，以上理论命题需要结合具体假定的参数来评估处理效应的稳健性。具体地，包括如何选择 $R_{\max}$ 和 $\delta$，如何据此生成系数的边界集合，以及如何解释这些结果来判断稳健性。

**1. 选择 $R_{\max}$（可解释的最大 $R^2$）：**

- $R_{\max}$ 决定了我们认为“如果包含所有相关变量，模型最多可以解释结果方差多少”。显然 $R_{\max}$ 必在当前 $R_1$ 和1之间（因为加入未观测变量只能提高 $R^2$ 但不可能超过 1 ）。
- 在没有额外信息时，一个常用做法是设定 **$R_{\max} = 1.3 \times R_1$** 作为经验值。这一特定选择来自Oster对随机实验数据的分析，发现若把 $R_{\max}$ 取为观测回归 $R_1$ 的1.3倍，约有45%的非随机研究结果在该标准下仍能幸存，被认为是稳健的。
- 当然，$R_{\max}$的取值应结合具体研究背景：如果我们认为即使加入所有潜在变量也不可能解释非常高比例的 $Y$ 方差（例如因为 $Y$ 有很大随机噪音），可以将 $R_{\max}$设得较低；反之，如果怀疑遗漏了非常关键的解释变量，可以取较高的 $R_{\max}$。总之，$R_{\max}$ 反映了研究者对结果中不可解释变异的预估，是稳健性检验中的一个关键敏感参数。
- 举例: 在某些劳动经济学研究中，$R_1$ （已有控制的 $R^2$ ）可能只有0.3左右。如果我们认为还有未观测能力、人格等因素，或测量误差，使得即便加上它们 $R^2$ 也达不到1，那么也许取 $R_{\max}=0.5$或$0.6$ 是合理的上限。Oster建议通过常识或领域知识尽量缩小$R_{\max}$ 与1之间的范围，以免高估未观测变量的潜力。

**2. 选择 $\delta$（选择偏差比例系数):**
    $\delta$ 的选取同样基于研究者对现实的判断。

- **基准假设 ($\delta=1$)：** 一个常用基准假设是 $\delta=1$，即认为研究中收集和控制的观测变量总体上已经与处理变量有相当的关联强度，未观测因素不太可能比这更强。这种假设有一定合理性：因为研究人员往往会优先收集他们认为最重要的混杂变量，因此剩下的未观测变量总体作用可能不如观测集。另外，由于 $W_2$ 已经对 $W_1$ 正交化处理（剔除了与 $W_1$ 相关的部分），理论上 $W_2$ 表示的是相对于已包含控制的“剩余”混杂，更难有极高的选择关联。
- **敏感性分析：** 根据具体情况，研究者也可以考虑 $\delta > 1$ 的情景以作更保守的稳健性检验，或考虑 $\delta < 1$ 如果认为未观测因素确实比观测的弱得多。实施时，可以选取几个代表性的 $\delta$ 值（例如 0、0.5、1、2 等）进行敏感性分析，观察调整结果的变化幅度。
  -   **边界情形：**
  * $\delta=0$：这相当于假设未观测因素与处理完全独立（没有选择偏差），此时 $\beta^* = \beta_1$（因为未观测偏误为 0）。因此 $\beta_1$ 本身构成了一个边界情形。
  * $\delta=1$：通常构成常用的另一端边界。
- **取值范围：** 在不引入更多假设时，$\delta$ 实际上可以从 0 延伸到 $+\infty$。不过鉴于正偏差假设和实际意义，通常我们认为 $\delta$ 不会无限大，可在较小区间内讨论（例如 $\delta$ 不太可能大于 3 或 5，在大多数应用中甚至很少超过 2）。

**3. 生成 $\beta$ 的边界集合：**

给定对 $R_{\max}$ 和 $\delta$ 的合理取值区间，我们可以利用命题 2 的公式计算一系列偏误调整系数 $\beta^*$。特别地，如果我们为 $R_{\max}$ 和 $\delta$ 选定上界（分别记作 $R_{\max}$ 和 $\bar{\delta}$），则可以定义识别边界集合：

$$
B_s = [\beta_1, \beta^*(R_{\max}, \bar{\delta})]
$$

其中：

* $\beta_1$ 对应 $R_{\max} = R_1$ 或 $\delta=0$ 的情形，即没有任何未观测偏误时的系数；
* $\beta^*(R_{\max}, \bar{\delta})$ 是在假设最悲观的偏误情形（$R_{\max}$ 最大且未观测偏差达到上界 $\bar{\delta}$）下调整得到的系数。

这个区间 $[\beta^*(R_{\max}, \bar{\delta}),\beta_1]$ 就是根据我们主观认可的偏误范围所识别出的可能真值区间。在 Oster 的建议中，一般取 $\bar{\delta}=1$ 作为上界假设，那么边界集合就是 $[\beta^*(R_{\max}, 1),\beta_1]$。在此范围内，任何 $\delta \in [0, 1]$ 和 $R_{\max} \in [R_1, \text{假定的} R_{\max}]$ 都会产生一个 $\beta^*$，这些取值都被视为尚在合理假定内可能的真实效应。

**4. 稳健性的评估：**

得到了边界集合（或若干感兴趣情形下的 $\beta^*$ 值）后，我们需要判断结果的稳健性。这通常通过以下方式进行：

* **是否包含零：**
  如果边界集合 $B_s$ 穿过 0 值，即 $0 \in [\beta_1, \beta^*(R_{\max}, \bar{\delta})]$，那么在假定的偏误范围内真实效应有可能为零，表明结果对未观测偏差不稳健。相反，如果整个区间仍然远离 0（例如全为正或全为负且不接近 0），则可以说结论较为稳健：即使考虑了最大可能的未观测偏误，处理效应的方向和显著性依然保持。例如，在加入控制后系数仍为正且显著，且计算得最偏不利调整下 $\beta^*$ 仍为正且与 0 差距明显，那么我们有理由相信结果不是由遗漏偏误驱动的。
* **区间长度与原估计的不确定性：**
  可以将 $B_s$ 的端点与原始估计 $\beta_1$ 的置信区间比较。如果偏误调整后的区间边界落入 $\beta_1$ 的置信区间内，则说明即便进行偏误校正，我们对效应的判断（例如显著性或经济显著性）可能没有根本改变。但如果 $\beta^*(R_{\max}, \bar{\delta})$ 比如落在 $\beta_1$ 的置信区间之外很多，意味着一旦考虑偏误，效应大小可能显著异于原估计，需要警惕。简单来说，我们希望观测控制下估计的结论在考虑合理范围的偏误调整后依然成立。
* **必要的 $R_{\max}$ 检验：**
  另一种补充分析方法是反过来求：在假定 $\delta=1$ 等较可信的前提下，需要怎样的 $R_{\max}$ 才能令 $\beta^*=0$。如果所需 $R_{\max}$ 非常高甚至接近 1，那么意味着除当前控制外未观测因素必须解释几乎所有剩余的方差才能使结果归零，这是不太可能的，因此结果稳健。反之，若只需略高于 $R_1$ 的 $R_{\max}$（比如再解释 5% 的方差）就足以让效应消失，那说明结果容易被少量未观测偏误推翻，稳健性较差。这种 $R_{\max}$ 需求量的讨论可以结合对结果的理解来定性说明稳健性。例如，我们可以报告：“在假定选择偏差 $\delta=1$ 的情况下，需要 $R_{\max}$ 达到 0.xx（显著高于目前 $R_1=0.yy$）才能将系数推至零。考虑到 $Y$ 包含的噪音和其他因素，我们认为让未观测变量额外解释如此大的方差是不大可能的”。通过这样的论证来加强对结果鲁棒性的信心。

---

# 3. 命令介绍

根据上述理论框架，本文编写了 Stata 命令 `coefstability`，实现了 Oster (2019) 提出的系数稳定性检验，可用于评估遗漏变量对线性回归模型因果推断的影响。该命令及相关帮助文档已集成在 GitHub 仓库 [Stata-Oster-2019](https://github.com/lmm51315-pixel/Stata-Oster-2019-Stata-) 的 `mydo/coefstability` 文件夹中，方便用户下载与调用。

## 3.1 命令概述

`coefstability` 通过对比**完整回归**（包含核心解释变量及观测控制变量）与**基准回归**（仅包含核心解释变量）的系数及 $R^2$ 变化，计算经偏误调整后的系数 $\beta^*$。

命令会在后台自动运行两个模型：

1. **完整模型 (Full Model)**：包含 `treatvar` 和 `controls`，得到系数 $\tilde{\beta}$ 和 $R^2$ ($\tilde{R}$)。
2. **基准模型 (Base Model)**：仅包含 `treatvar`（及其隐含的固定效应，若适用），得到系数 $\mathring{\beta}$ 和 $R^2$ ($\mathring{R}$)。

随后根据 Oster (2019) 的公式计算调整后系数：

$$
\beta^* = \tilde{\beta} - \delta \times (\mathring{\beta} - \tilde{\beta}) \times \frac{R_{\max} - \tilde{R}}{\tilde{R} - \mathring{R}}
$$

本命令支持基础的 `regress`，以及 `reghdfe` (多维固定效应) 和 `xtreg` (面板数据) 等常用线性模型，并针对复杂模型的 Bootstrap 推断进行了专门优化以确保稳定性。

## 3.2 语法 (Syntax)

```stata
coefstability depvar treatvar [if] [in], controls(varlist) [options]
```

## 3.3 选项 (Options)

### 3.3.1 核心设定

* **`depvar`**：因变量。
* **`treatvar`**：处理变量（核心解释变量）。
* **`controls(varlist)`**：**(必填)** 控制变量列表。程序将通过对比加入这些变量前后的系数变化来进行稳定性检验。

### 3.3.2 参数设定

* **`delta(#)`**：设定未观测变量与观测变量的选择比例系数 $\delta$，**默认为 1**。
  * $\delta=1$ 意味着未观测变量对处理变量的影响程度与已观测控制变量相同。
* **`rmax(#)`**：设定理论最大 $R^2$ ($R_{\max}$)。
  * **默认值 (Auto)**：若不指定，程序将自动设定 $R_{\max} = \min(1, \ 1.3 \times \tilde{R})$，即完整模型 $R^2$ 的 1.3 倍（但不超过 1），这是 Oster (2019) 推荐的标准做法。
  * 用户也可以手动指定一个 $0$ 到 $1$ 之间的数值，但必须大于完整模型的 $\tilde{R}$。
* **`model(string)`**：指定估计命令，**默认为 `regress`**。
  * 支持 `reghdfe`、`xtreg`、`ivreghdfe` 等。
* **`modelopts(string)`**：传递给回归命令的其他选项（如固定效应 `absorb(...)` 或面板选项 `fe` 等）。

### 3.3.3 统计推断 (Bootstrap)

* **`bootstrap`**：启用自助法（Bootstrap）以获得 $\beta^*$ 的标准误和置信区间。
  * *注意*：针对 `reghdfe` 等复杂模型，程序内部对 Bootstrap 过程进行了优化，避免了在重抽样迭代中重复计算聚类标准误导致的报错。
* **`reps(#)`**：Bootstrap 重复次数，**默认为 1000**。
* **`seed(#)`**：随机数种子，**默认为 12345**，保证结果可复现。
* **`cluster(varname)`**：指定聚类变量。
  * 用于计算原始回归的聚类标准误，并在 Bootstrap 中执行聚类抽样（Cluster Bootstrap）。
* **`level(#)`**：置信区间的置信水平（如 95），默认为系统设定。

### 3.3.4 结果输出

* **`noisily`**：在结果窗口显示详细的回归计算过程（包括基准模型和完整模型的原始输出）。
* **`saving(filename)`**：将计算结果（若启用了 Bootstrap，包含所有迭代的抽样值）保存为 `.dta` 文件。

## 3.4 返回值 (Stored Results)

命令运行结束后，核心结果将存储在 `r()` 中：

| 标量名称                    | 描述                                                            |
| :-------------------------- | :-------------------------------------------------------------- |
| **`r(beta_star)`**  | **调整后系数** $\beta^*$ (Oster's Beta)                 |
| **`r(delta_star)`** | **临界 $\delta$ 值** (使 $\beta^*=0$ 时的 $\delta$) |
| **`r(b_full)`**     | 完整模型的原始系数$\tilde{\beta}$                             |
| **`r(b_base)`**     | 基准模型的原始系数$\mathring{\beta}$                          |
| **`r(r2_full)`**    | 完整模型的$R^2$ ($\tilde{R}$)                               |
| **`r(r2_base)`**    | 基准模型的$R^2$ ($\mathring{R}$)                            |
| **`r(rmax)`**       | 计算中使用的$R_{\max}$ 值                                     |
| **`r(delta)`**      | 计算中使用的$\delta$ 值                                       |

*若启用了 `bootstrap`，还包含以下统计量：*

| 标量名称                  | 描述                            |
| :------------------------ | :------------------------------ |
| **`r(se_star)`**  | $\beta^*$ 的 Bootstrap 标准误 |
| **`r(ci_lower)`** | $\beta^*$ 的置信区间下限      |
| **`r(ci_upper)`** | $\beta^*$ 的置信区间上限      |

---

# 4. 应用示例

本节旨在通过具体的实证论文案例，演示如何使用 `coefstability` 命令进行系数稳定性检验。我们将展示如何复现知名期刊中的检验过程，并对比本命令与传统命令的输出效果。

## 4.1 案例1：金融包容性与碳排放——复现 Acheampong & Said (2024)

> **Source**: Acheampong, A. O., & Said, R. (2024). Financial inclusion and the global net-zero emissions agenda: Does governance quality matter? Energy Economics, 137, 107785. [Link](https://doi.org/10.1016/j.eneco.2024.107785) (rep), [PDF](http://sci-hub.ren/10.1016/j.eneco.2024.107785), [Google](<https://scholar.google.com/scholar?q=Financial inclusion and the global net-zero emissions agenda: Does governance quality matter>). [Replication](https://ars.els-cdn.com/content/image/1-s2.0-S0140988324004936-mmc1.zip) 

### 4.1.1 文献背景与检验目的

Acheampong 和 Said (2024) 在《Energy Economics》发表的文章中，探讨了**金融包容性 (Financial Inclusion, FI)** 对全球净零排放议程的影响。为了验证主要结论的可靠性，作者需要排除潜在的内生性问题，特别是**遗漏变量偏差 (Omitted Variable Bias)**。

由于很难穷尽所有影响碳排放的因素，作者采用了 Oster (2019) 提出的理论框架进行稳健性检验。其核心逻辑是：通过观察引入控制变量后系数 ($\beta$) 和拟合优度 ($R^2$) 的变化，来推断未观测到的遗漏变量需要有多大的解释力（$\delta$）才能完全推翻现有结论（即让 $\beta$ 变为 0）。

### 4.1.2 原文实现方式 (`psacalc`)

在原文中，作者使用了 `psacalc` 命令来计算调整后的系数和稳健性参数。原文代码如下：

```stata
// Table 10: Oster (2019) test for omitted variable bias
// OLS results and Oster stability test
eststo clear
eststo: regress lnco2kt lnrgdpc lnrgdpc2 lnrenew lnfdi lntrad lnurb FI $tlist , robust
psacalc delta FI, rmax(1)
```

**原文输出结果：**
<img src="https://fig-lianxh.oss-cn-shenzhen.aliyuncs.com/undefined%E6%88%AA%E5%B1%8F2026-01-14%2011.32.32.png" width="650" alt="FE马俊豪-2024-Fig01_psacalc命令结果-马俊豪.png">

可以看到，`psacalc` 的输出主要集中在计算结果本身（如 Identified beta 或 Delta），但缺乏对基准模型（Base Model）和完整模型（Full Model）参数变化的直观展示，用户往往需要手动记录回归结果进行对比。

### 4.1.3 使用 `coefstability` 实现

使用本文编写的 `coefstability` 命令，我们可以在一行代码中完成模型估计、参数提取及 Oster 检验，并获得更加丰富的信息。代码如下：

```stata
coefstability lnco2kt FI, ///
    controls(lnrgdpc2 lnrenew lnfdi lntrad lnurb lnrgdpc) ///
    model(regress) ///
    modelopts(robust) ///
    delta(1) rmax(1) 
```

**本命令输出结果：**
<img src="https://fig-lianxh.oss-cn-shenzhen.aliyuncs.com/undefined%E6%88%AA%E5%B1%8F2026-01-14%2011.39.39.png" width="650" alt="FE马俊豪-2024-Fig02_coefstability检验结果-马俊豪.png">

### 4.1.4 结果对比与优势分析

对比上述两种输出结果，可以看出 `coefstability` 具有以下的优势：

1. **信息呈现更全面**：

   * `psacalc` 侧重于最终的计算值。
   * `coefstability` 采用了标准的回归表格形式，**同时展示了“含控制变量（完整模型）”和“基准模型”** 的系数、P值、R² 及 调整R²。这使得研究者可以直观地看到：加入控制变量后，系数发生了多大程度的衰减，以及模型的解释力提升了多少（$R^2$ 的变化），这正是 Oster 检验的核心逻辑所在。
2. **结果解读更直观**：

   * 输出结果直接给出了调整后的系数 $\beta^*$（Adjusted Beta）以及对应的置信区间（如果启用了 bootstrap）。
   * 底部的稳健性分析部分清晰地报告了 $\delta$ 和 $R_{max}$ 的参数设定，并给出了临界 $\delta^*$ 值的解释，帮助用户快速判断结果的稳健程度（例如：是否需要未观测因素的作用力远大于观测因素才能推翻结论）。


---

## 4.2 案例2：气候变化风险与权益资本成本——复现 Cepni et al. (2024)

> **Source**: Cepni, O., Şensoy, A., & Yılmaz, M. H. (2024). Climate change exposure and cost of equity. Energy Economics, 130, 107288. [Link](https://doi.org/10.1016/j.eneco.2023.107288) (rep), [PDF](https://file-lianxh.oss-cn-shenzhen.aliyuncs.com/Refs/2026-Spring/Cepni_2024_Climate_change_exposure_and_cost_of_equity.pdf), [Google](<https://scholar.google.com/scholar?q=Climate change exposure and cost of equity>). [Replication](https://ars.els-cdn.com/content/image/1-s2.0-S0140988323007867-mmc1.zip)

### 4.2.1 文献简介与背景

随着气候变化逐渐成为全球关注的焦点，投资者是否会因企业面临的气候风险而要求更高的回报率？Cepni, Şensoy 和 Yılmaz (2024) 在 *Energy Economics* 发表的文章深入探讨了这一问题。文章构建了衡量企业面临气候变化风险（Physical and Transition Risks）的指标，并检验了该指标与权益资本成本（Cost of Equity）之间的关系。

研究发现，气候变化暴露程度越高的企业，其权益资本成本也显著更高。这一发现对于理解气候风险在资产定价中的作用具有重要意义。虽然原文主要通过逐步添加控制变量的方法来展示结果的稳定性，并未直接使用 Oster (2019) 的形式化检验，但其研究逻辑与 Oster 方法的核心思想——**观察系数在引入控制变量后的变动幅度**——是不谋而合的。

### 4.2.2 原文回归设定

作者在原文中采用了标准的两步法回归策略：首先进行仅包含核心解释变量的单变量回归（基准模型），随后加入一系列公司层面的控制变量（完整模型）。原文的 Stata 代码逻辑如下：

```stata
use main_sample, clear
xtset GVKEY_num year

* Baseline estimations (OLS with Fixed Effects)
* 基准模型：仅包含核心解释变量 L.ln_cc_expo_ew_w1
reghdfe cost_of_equity_w1 L.ln_cc_expo_ew_w1, ///
    absorb(GVKEY_num year) vce(cluster GICIndustries)

* Full estimations
* 完整模型：加入账面市值比、公司规模、净利率等控制变量
reghdfe cost_of_equity_w1 L.ln_cc_expo_ew_w1 ///
    L.bm_w1 L.firm_size_w1 L.npm_w1 L.roa_w1 L.debt_at_w1 L.rd_sale_w1, ///
    absorb(GVKEY_num year) vce(cluster GICIndustries)
```

### 4.2.3 应用 `coefstability` 进行稳定性检验

为了更严谨地量化不可观测变量对结果的潜在影响，我们使用本文编写的 `coefstability` 命令对上述过程进行一键式复现和检验。代码如下：

```stata
* 设定随机种子以保证 Bootstrap 结果可复现
coefstability cost_of_equity_w1 L.ln_cc_expo_ew_w1, ///
    controls(L.bm_w1 L.firm_size_w1 L.npm_w1 L.roa_w1 L.debt_at_w1 L.rd_sale_w1) ///
    model(reghdfe) ///
    modelopts(absorb(GVKEY_num year)) ///
    cluster(GICIndustries) ///
    delta(1) rmax(-1) ///
    bootstrap reps(100) seed(12345) ///
    noisily
```

**运行结果如下：**

<div align="center">
  <img src="https://fig-lianxh.oss-cn-shenzhen.aliyuncs.com/undefined%E6%88%AA%E5%B1%8F2026-01-14%2014.33.40.png" width="650" alt="FE马俊豪-2024-Fig03_coefstability检验结果-马俊豪.png">
</div>

检验结果显示，在考虑了不可观测变量的选择偏误后（Adjusted Beta），系数依然稳健，这进一步支持了 Cepni et al. (2024) 的核心结论。

### 4.2.4 关键技术细节：为什么基准回归系数变了？

细心的读者可能会发现一个有趣的现象：

* **含控制变量时**：`coefstability` 得到的系数（0.8357）与原文直接运行 `reghdfe` 得到的系数完全一致。
* **无控制变量（基准）时**：原文 `reghdfe` 跑出的系数是 **0.9635**，但 `coefstability` 报告的基准系数却是 **0.8028**。

**这种差异不仅是正常的，而且是实施 Oster (2019) 检验所必须的。** 原因如下：

1. **样本匹配原则（Sample Consistency）**：
   当我们运行含大量控制变量的完整模型时，Stata 会自动执行**列表删除（Listwise Deletion）**，即剔除任何一个控制变量（如 `L.rd_sale_w1`）存在缺失值的观测样本。而当手动运行不含控制变量的基准回归时，由于不需要用到那些有缺失的控制变量，Stata 会保留更多的样本，导致**样本量膨胀**。
2. **Oster 方法的数学要求**：
   系数稳定性检验的核心逻辑在于比较加入控制变量前后 $R^2$ 的变化（$\Delta R^2$）。

   * 如果基准模型和完整模型使用的样本不同，那么 $R^2$ 的变化就混杂了“样本构成变化”和“解释力变化”两种因素。
   * 我们无法判断 $R^2$ 的提升是因为控制变量真的有效，还是仅仅因为那些难以预测的“噪音样本”因数据缺失被剔除了。
3. **程序处理机制**：
   为了保证 $\Delta R_{full}^2 - R_{base}^2$ 具有数学意义，`coefstability` 命令**强制锁定了样本**。它首先运行完整模型确定最终有效样本（Sample A），然后强制基准模型也在 Sample A 上运行。程序内部实际上执行的是：

   ```stata
   reghdfe y x if e(sample)_of_full_model, ...
   ```

   因此，0.8028 才是真正具备可比性的基准系数。这确保了系数的变动纯粹源于控制变量的引入，而非样本的变动，从而防止系数稳定性检验的逻辑崩塌。

## 4.3 其他用法展示
除前文案例复现外，`coefstability` 命令提供了丰富的参数选项以适应不同的研究场景。本节使用 Stata 内置数据集，系统展示从基础到进阶的完整功能链条，具体如下
```stata
* ----------- 示例1：基础模型设定 ----------- *
* 功能：展示最简洁的命令形式
* 模型：普通最小二乘法（OLS）
sysuse auto, clear

coefstability price mpg, ///
    controls(weight length)

* ----------- 示例2：关键参数校准 ----------- *
* 功能：手动设定 Oster (2019) 检验的核心参数
* δ = 0.5:  假设未观测变量的选择强度为已观测变量的一半
* Rmax = 0.8: 设定包含所有潜在变量后的理论R²上限
sysuse auto, clear

coefstability price mpg,                ///
    controls(weight length)             ///
    delta(0.5) rmax(0.8)

* ----------- 示例3：Bootstrap 标准误 ----------- *
* 功能：通过自助法计算调整后系数 β* 的标准误与置信区间
* 注意：`bootstrap` 为内置命令，无需额外安装
sysuse auto, clear

coefstability price mpg,                ///
    controls(weight length)             ///
    bootstrap reps(500) seed(12345)

* ----------- 示例4：高维固定效应模型 ----------- *
* 功能：与 `reghdfe` 命令结合，吸收单一固定效应
* 用途：控制不随时间/个体变化的遗漏变量
sysuse auto, clear

coefstability price mpg,                ///
    controls(weight length)             ///
    model(reghdfe)                      ///
    modelopts(absorb(rep78))

* ----------- 示例5：面板数据基础操作 ----------- *
* 说明：本部分为预备步骤，用于声明面板数据结构。
*       声明后，方可使用 `L.`、`F.` 等时间序列运算符。
webuse nlswork, clear
xtset idcode year

* ----------- 示例6：面板固定效应模型 ----------- *
* 功能：使用 `xtreg, fe` 进行面板固定效应估计
* 特点：同时控制个体效应和时间效应（通过 i.year）
coefstability ln_wage hours,            ///
    controls(age ttl_exp tenure         ///
             not_smsa south i.year)     ///
    model(xtreg)                        ///
    modelopts(fe)                       ///
    delta(1) rmax(1)                    ///
    bootstrap reps(100) seed(12345)

* ----------- 示例7：高维双向固定效应进阶 ----------- *
* 功能：`reghdfe` + 双向固定效应 + 聚类标准误 + 自助法
* rmax(-1): 程序自动计算理论R²上限
* noisily: 显示bootstrap迭代过程
coefstability ln_wage hours,            ///
    controls(age ttl_exp tenure         ///
             not_smsa south)            ///
    model(reghdfe)                      ///
    modelopts(absorb(idcode year))      ///
    cluster(idcode)                     ///
    delta(0.8) rmax(-1)                 ///
    bootstrap reps(100) seed(12345)     ///
    noisily
```

# 5. 结语

本文介绍的 `coefstability` 命令为应用研究者提供了一个便利的工具，将 Oster（2019）的系数稳定性检验方法自动化地融入 Stata 分析流程中。通过该命令，用户可以轻松地在估计完回归模型后，对照输入感兴趣的处理变量及控制变量名单，并假定合理的 $\delta$ 和 $R_{\max}$ 参数，即可获得偏误调整后的效应估计及稳健性指标。这大大降低了实施 Oster 方法的技术门槛，使得遗漏变量偏误的敏感性分析能够更广泛地应用于实证研究中。

`coefstability` 的输出直观地展示了观测控制的效果和假设未观测偏误下处理效应的变化，为研究者判断结果稳健性提供了依据。例如，通过报告的 $\delta^*$ 临界值，研究者可以直接回答：“需要多强的未观测混杂才能使本结果无效？”这种定量指标对于论文写作和结果讨论很有价值。当 $\delta^*$ 很大时，我们可以有依据地声称结果在常理范围内是稳健的；反之，如果 $\delta^*$ 接近或小于 1，那么即便控制了观测变量，遗漏因素仍可能推翻结论，作者应据此提高对结论的保留态度或寻求更多证据支持。

需要指出的是，稳健性检验的结论取决于用户对 $\delta$ 和 $R_{\max}$ 的设定。`coefstability` 为不同假设情景下的偏误校正计算提供了便利，但如何选择恰当的 $R_{\max}$ 和 $\delta$ 仍然需要研究者依据经验和背景知识。Oster（2019）建议研究者可以结合领域知识或外部数据（例如随机实验结果）来为 $R_{\max}$ 设定合理的上限（一般为1.3倍的$\tilde{R}$)）；类似地，$\delta$ 的取值可以通过比较观测变量与潜在遗漏因素的影响渠道相似性来判断。在实际应用中，研究者往往会针对多个 $R_{\max}$ 和 $\delta$ 组合反复使用本命令，检查调整结果是否一致朝某一方向变化，从而形成对稳健性的综合判断。

总的来说，`coefstability` 命令的推出丰富了 Stata 在因果推断稳健性分析方面的工具箱，使得 Oster 提出的系数稳定性检验方法易于应用和推广。通过该命令，研究者能够更系统地评估未观测混杂对结果的潜在影响，在一定程度上回答“如果还有遗漏变量，结果会不会翻转？”这一关键问题。在未来，该命令还可进一步扩展，如支持用户指定多个感兴趣系数的批量分析、结合不同模型类型的稳健性检验等。但就目前而言，`coefstability` 已为实证工作提供了一条简洁的途径来检验结论的稳健性，并鼓励研究者在报告主要结果时同步考虑遗漏变量偏误的可能性。这将有助于提升因果推断的可信度，促使学术研究更加严谨完善。

## 7. 参考文献

本文的理论和实证部分主要参考下面的几篇文献。

> Oster, E. (**2019**). Unobservable Selection and Coefficient Stability: Theory and Evidence. **Journal of Business & Economic Statistics**, 37(2), 187–204. [Link](https://doi.org/10.1080/07350015.2016.1227711), [PDF](http://sci-hub.ren/10.1080/07350015.2016.1227711), [Google](<https://scholar.google.com/scholar?q=Unobservable Selection and Coefficient Stability: Theory and Evidence>). [-cited-5000次](https://scholar.google.com/scholar?cites=11936978270607540916&as_sdt=2005&sciodt=0,5&hl=zh-CN), [github-`coefstability`](https://github.com/gratzt/Coef-Stability-Oster)

> Acheampong, A. O., & Said, R. (2024). Financial inclusion and the global net-zero emissions agenda: Does governance quality matter? Energy Economics, 137, 107785. [Link](https://doi.org/10.1016/j.eneco.2024.107785) (rep), [PDF](http://sci-hub.ren/10.1016/j.eneco.2024.107785), [Google](<https://scholar.google.com/scholar?q=Financial inclusion and the global net-zero emissions agenda: Does governance quality matter>). [Replication](https://ars.els-cdn.com/content/image/1-s2.0-S0140988324004936-mmc1.zip) 

> Cepni, O., Şensoy, A., & Yılmaz, M. H. (2024). Climate change exposure and cost of equity. Energy Economics, 130, 107288. [Link](https://doi.org/10.1016/j.eneco.2023.107288) (rep), [PDF](https://file-lianxh.oss-cn-shenzhen.aliyuncs.com/Refs/2026-Spring/Cepni_2024_Climate_change_exposure_and_cost_of_equity.pdf), [Google](<https://scholar.google.com/scholar?q=Climate change exposure and cost of equity>). [Replication](https://ars.els-cdn.com/content/image/1-s2.0-S0140988323007867-mmc1.zip)