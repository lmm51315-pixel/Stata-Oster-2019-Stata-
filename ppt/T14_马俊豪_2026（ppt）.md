---
marp: true
theme: default
size: 16:9
paginate: true
math: katex
style: |
  section {
    font-size: 26px;
    padding: 40px 60px;
    background-color: #ffffff;
  }
  h1 {
    color: #003366;
    font-size: 50px;
  }
  h2 {
    color: #003366;
    border-bottom: 2px solid #003366;
    padding-bottom: 10px;
    margin-bottom: 30px;
  }
  strong {
    color: #cc0000;
  }
  code {
    background-color: #f0f0f0;
    color: #d63384;
    padding: 2px 5px;
    border-radius: 4px;
  }
  pre {
    background-color: #f6f8fa;
    border-radius: 6px;
    padding: 15px;
  }
  table {
    font-size: 22px;
  }
  /* 自定义分栏样式 */
  .columns {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 1rem;
  }
header: "Stata 程序编写：Oster (2019) 系数稳定性检验"
footer: "马俊豪 | 中山大学岭南学院"
---

<!-- _class: lead -->
<!-- _header: "" -->
<!-- _footer: "" -->

# Stata 程序编写
## Oster (2019) 系数稳定性检验的 Stata 实现

<br>

**作者：马俊豪 (中山大学岭南学院)**

---

## 目录

1. **引言**：背景与动机
2. **理论回顾**：为什么只看系数稳定是不够的？
3. **命令介绍**：`coefstability` 的功能与语法
4. **应用示例**：复现两篇经典文献
5. **结语**：总结与展望

---

<!-- _class: lead -->
# 1. 引言

---

## 问题的提出

- **因果推断的挑战**：
  研究常面临**遗漏变量偏误 (OVB)** 问题，未观测因素可能严重影响估计结果。

- **传统做法**：
  通过比较加入控制变量前后的系数变化来判断稳健性。
  > *直觉：若加入控制变量后，核心解释变量的系数几乎不变，通常认为遗漏变量偏误有限。*

---

## 传统做法的局限

- **系数稳定 $\neq$ 结果稳健**
  Oster (2019) 指出，必须同时考察 **系数** 与 **模型 $R^2$** 的变化。

- **判断逻辑**：
  1. **稳健**：加控制后 $R^2$ **提升显著** 而系数 **几乎不变**。
     *(说明观测变量解释力强，但未改变核心结论)*
  2. **不稳健**：加控制后 $R^2$ **提升甚微** 但系数 **变化很大**。
     *(说明即使很小的未观测因素也可能剧烈改变结果)*

---

<!-- _class: lead -->
# 2. 文章理论回顾

---

## 理论陷阱：为什么系数会“假装”稳定？

假设真实模型为 $Y = \beta X + W + C$，其中 $C$ 是控制变量。

- **情景**：若控制变量 $C$ 的方差很小。
- **结果**：
  1. **系数近似相等**：$\hat\beta^{\,C} \approx \hat\beta^{\,0}$。
  2. **$R^2$ 提升极小**：诊断出 $C$ 对 $Y$ 的解释力很弱。
  
- **结论**：系数稳定可能仅仅是因为控制变量“含金量”不足（方差小），无法消除主要偏误。此时遗漏的高方差混杂变量 $W$ 仍在造成偏误。

---

## Oster (2019) 的解决方案

- **核心思想**：形式化结合 **系数变化** 与 **$R^2$ 变化** 的检验方法。
- **关键参数**：
  - $\delta$：未观测因素相对于已观测因素的选择偏差比例（$\delta=1$ 表示二者重要性相同）。
  - $R_{\max}$：理论最大拟合优度，常取完整模型 $R^2$ 的 1.3 倍（上限为 1）。
  
- **输出指标**：
  - **$\beta^*$**：经偏误调整后的真实系数估计。
  - **$\delta^*$**：使 $\beta^* = 0$ 时所需的临界 $\delta$ 值。

---

## 调整后系数 $\beta^*$ 计算公式

$$
\beta^* = \tilde{\beta} - \delta \times (\mathring{\beta} - \tilde{\beta}) \times \frac{R_{\max} - \tilde{R}}{\tilde{R} - \mathring{R}}
$$

<br>

- $\mathring{\beta}, \mathring{R}$：**基准模型** (Baseline) 的系数和 $R^2$。
- $\tilde{\beta}, \tilde{R}$：**完整模型** (Full Model) 的系数和 $R^2$。
- **$\delta^*$**：令上式 $\beta^* = 0$ 反解出的 $\delta$，代表未观测选择偏差需要多强才能推翻结论。

---

<!-- _class: lead -->
# 3. 命令介绍

---

## 命令概述：`coefstability`

- **功能**：将 Oster (2019) 检验自动化融入 Stata 线性回归流程。
- **工作流**：
  1. 后台自动运行 **完整模型** 和 **基准模型**。
  2. 提取 $\tilde{\beta}, \mathring{\beta}$ 及对应 $R^2$。
  3. 计算调整后系数 $\beta^*$ 和临界值 $\delta^*$。
- **兼容性**：支持 OLS (`regress`)、高维固定效应 (`reghdfe`)、面板 (`xtreg`) 及 IV 模型。
- **推断**：针对复杂模型优化了 Bootstrap 过程。

---

## 基本语法

```stata
coefstability depvar treatvar [if] [in], controls(varlist) [options]
```

### 主要选项 (必选与常用)

| 选项 | 说明 |
| :--- | :--- |
| **`controls(varlist)`** | 指定控制变量列表（程序将自动比对加控制前后的变化）。 |
| **`delta(#)`** | 设定未观测/观测变量的选择偏差比例，默认 `= 1`。 |
| **`rmax(#)`** | 设定 $R_{\max}$。默认自动设为完整模型 $R^2$ 的 1.3 倍。 |
| **`model(name)`** | 指定估计命令，默认为 `regress` (支持 `reghdfe`, `xtreg` 等)。 |
| **`modelopts(str)`** | 传递给回归命令的附加选项 (如 `absorb(...)`, `fe`)。 |

---

## 进阶选项：推断与输出

<div class="columns">

<div>

### 统计推断
- **`bootstrap`**
  启用自助法计算 $\beta^*$ 的标准误和置信区间。
- **`reps(#)`**
  重复抽样次数，默认 1000。
- **`seed(#)`**
  设定随机种子，保证可复现 (默认 12345)。
- **`cluster(varname)`**
  指定聚类变量 (基准回归沿用该聚类，并执行聚类 Bootstrap)。

</div>

<div>

### 输出与保存
- **`noisily`**
  显示基准模型和完整模型的详细回归输出。
- **`saving(filename)`**
  将计算结果保存为 `.dta` 数据文件。

</div>
</div>

---

## 存储结果 (Stored Results)

运行结束后，核心结果存储于 `r()` 标量中：

| 标量 | 含义 | 标量 | 含义 |
| :--- | :--- | :--- | :--- |
| `r(beta_star)` | **调整后系数** $\beta^*$ | `r(b_full)` | 完整模型系数 $\tilde{\beta}$ |
| `r(delta_star)` | **临界值** $\delta^*$ | `r(b_base)` | 基准模型系数 $\mathring{\beta}$ |
| `r(rmax)` | 使用的 $R_{\max}$ | `r(r2_full)` | 完整模型 $R^2$ |
| `r(delta)` | 使用的 $\delta$ | `r(r2_base)` | 基准模型 $R^2$ |

*(若启用 bootstrap，另包含 `r(se_star)`, `r(ci_lower)`, `r(ci_upper)`)*

---

<!-- _class: lead -->
# 4. 应用示例

---

## 案例 1：金融包容性与碳排放
**来源**：Acheampong & Said (2024), *Energy Economics*

- **背景**：检验金融包容性 (FI) 对碳排放的影响。
- **原方法 (`psacalc`)**：
  ```stata
  regress lnco2kt lnrgdpc ... lnurb FI, robust
  psacalc delta FI, rmax(1)
  ```
- **新方法 (`coefstability`)**：
  ```stata
  coefstability lnco2kt FI, ///
      controls(lnrgdpc2 lnrenew lnfdi lntrad lnurb lnrgdpc) ///
      model(regress) modelopts(robust) ///
      delta(1) rmax(1)
  ```

---

## 结果可视化对比

<style scoped>
.comparison-container {
  display: grid;
  grid-template-columns: 1fr 1fr; /* 左右两列等宽 */
  gap: 30px; /* 列间距 */
  align-items: start;
}
.col-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
}
.img-wrapper {
  height: 450px; /* 【关键】强制固定图片容器高度 */
  width: 100%;
  display: flex;
  align-items: center; /* 图片垂直居中 */
  justify-content: center;
  background-color: #f8f9fa; /* 可选：淡灰色背景框，方便看清边界 */
  border: 1px solid #e0e0e0;
  margin-top: 10px;
  border-radius: 8px;
}
.img-wrapper img {
  max-height: 100%;
  max-width: 100%;
  object-fit: contain; /* 保证图片在框内完整显示且不变形 */
  box-shadow: none; /* 去除默认阴影，保持干净 */
}
</style>

<div class="comparison-container">

  <!-- 左侧列 -->
  <div class="col-item">
    <strong>1. 原文输出结果 (psacalc)</strong>
    <div class="img-wrapper">
      <img src="https://fig-lianxh.oss-cn-shenzhen.aliyuncs.com/undefined%E6%88%AA%E5%B1%8F2026-01-14%2011.32.32.png" />
    </div>
    <span style="font-size: 0.8em; color: gray;">*仅展示计算参数，缺乏细节*</span>
  </div>

  <!-- 右侧列 -->
  <div class="col-item">
    <strong>2. 本命令输出结果 (coefstability)</strong>
    <div class="img-wrapper">
      <img src="https://fig-lianxh.oss-cn-shenzhen.aliyuncs.com/undefined%E6%88%AA%E5%B1%8F2026-01-14%2011.39.39.png" />
    </div>
    <span style="font-size: 0.8em; color: gray;">*完整展示基准与完整模型对比*</span>
  </div>

</div>

---


### `coefstability` 的优势

1. **信息呈现更全面**：
   - 输出标准回归表格，同时列出 **完整模型** 和 **基准模型** 的系数、P值、$R^2$。
   - 直观体现加入控制变量后系数衰减幅度及模型解释力提升。
   *(对比上一页：psacalc 仅给出最终计算值)*

2. **结果解读更直观**：
   - 直接报告 $\beta^*$ 及置信区间。
   - 清晰给出 $\delta$、$R_{\max}$ 及临界 $\delta^*$。
   - 帮助快速评估：**需要多强的未观测因素才能推翻结论？**


---

## 案例 2：气候风险与权益资本成本
**来源**：Cepni et al. (2024), *Energy Economics*

- **背景**：风险暴露越高，企业权益资本成本是否显著增加？
- **实现代码 (含高维固定效应与 Bootstrap)**：

```stata
coefstability cost_of_equity_w1 L.ln_cc_expo_ew_w1, ///
    controls(L.bm_w1 L.firm_size_w1 ... L.rd_sale_w1) ///
    model(reghdfe) ///
    modelopts(absorb(GVKEY_num year)) ///
    cluster(GICIndustries) ///
    delta(1) rmax(-1) ///  // -1 表示自动计算 1.3倍 R2
    bootstrap reps(100) seed(12345) noisily
```
- **结论**：考虑偏误校正后系数依然稳健，支持原文结论。

---

## 关键细节：样本一致性原则 (Sample Consistency)

- **问题**：
  完整模型 (Full) 会因控制变量缺失而**删除样本**；若单独跑基准模型 (Base)，样本量会膨胀。
  $\rightarrow$ **后果**：$\Delta R^2$ 混杂了样本变化，导致 Oster 检验失效。

- **`coefstability` 解决方案**：
  1. 先运行完整模型，锁定有效样本 (`e(sample)`)。
  2. 强制基准模型在**同一子样本**上运行。
  3. **确保 $\Delta R^2$ 纯粹反映控制变量的贡献。**

---

<!-- _class: lead -->
# 5. 结语

---

## 总结

1. **自动化流程**：`coefstability` 降低了实施 Oster (2019) 检验的技术门槛。
2. **直观输出**：同时展示系数变化、$\beta^*$ 及 $\delta^*$，直接回答“结果是否稳健”。
3. **灵活性**：支持多种模型 (OLS, FE, IV) 与自定义参数 ($R_{\max}, \delta$)。
4. **注意事项**：结论依赖于参数设定，建议汇报不同 $R_{\max}$ 和 $\delta$ 下的结果以增强说服力。

**价值**：丰富了因果推断工具箱，助力研究者更系统地评估未观测混杂的影响。

---

## 参考文献

<style scoped>
p { font-size: 22px; }
</style>

1. **Oster, E. (2019).** Unobservable Selection and Coefficient Stability: Theory and Evidence. *Journal of Business & Economic Statistics*, 37(2), 187–204.
2. **Acheampong, A. O., & Said, R. (2024).** Financial inclusion and the global net-zero emissions agenda: Does governance quality matter? *Energy Economics*, 137, 107785.
3. **Cepni, O., Şensoy, A., & Yılmaz, M. H. (2024).** Climate change exposure and cost of equity. *Energy Economics*, 130, 107288.

<br>

--- 

**谢谢聆听！**